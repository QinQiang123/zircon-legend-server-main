name: Build Linux Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: |
        echo "æ­£åœ¨è¿˜åŸä¾èµ–é¡¹..."
        dotnet restore "Server/Server.csproj" -v detailed

    - name: Build
      run: |
        echo "æ­£åœ¨ç¼–è¯‘é¡¹ç›®..."
        dotnet build "Server/Server.csproj" --configuration Release --no-restore -v detailed

    - name: Publish Linux x64
      run: |
        echo "æ­£åœ¨å‘å¸ƒ Linux x64 ç‰ˆæœ¬..."
        dotnet publish "Server/Server.csproj" -c Release -r linux-x64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o ./publish/linux-x64
        echo "å‘å¸ƒå®Œæˆï¼Œæ–‡ä»¶åˆ—è¡¨ï¼š"
        Get-ChildItem -Path ./publish/linux-x64/ -Force
      shell: pwsh

    - name: Archive Linux x64 build
      run: |
        cd publish/linux-x64
        tar -czf ../Server-linux-x64.tar.gz *
      shell: bash

    - name: Upload Linux x64 artifact
      uses: actions/upload-artifact@v4
      with:
        name: Server-linux-x64
        path: publish/Server-linux-x64.tar.gz
        retention-days: 30

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          publish/Server-linux-x64.tar.gz
        body: |
          ## ğŸ‰ Linux x64 å‘å¸ƒç‰ˆæœ¬
          
          ### ğŸ“¦ åŒ…å«å†…å®¹
          - Server å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆè‡ªåŒ…å« .NET 8.0 è¿è¡Œæ—¶ï¼‰
          - Library ä¾èµ–åº“
          - Web ç®¡ç†é¢æ¿é™æ€èµ„æº
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          ```bash
          # è§£å‹æ–‡ä»¶
          tar -xzf Server-linux-x64.tar.gz
          
          # æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x Server
          
          # è¿è¡ŒæœåŠ¡å™¨
          ./Server
          ```
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Linux x64 ç³»ç»Ÿ
          - æ— éœ€å®‰è£… .NET è¿è¡Œæ—¶ï¼ˆå·²åŒ…å«ï¼‰
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
