name: Build Linux Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux-x64:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: |
        echo "æ­£åœ¨è¿˜åŸä¾èµ–é¡¹..."
        dotnet restore "Server/Server.csproj" -v detailed

    - name: Build
      run: |
        echo "æ­£åœ¨ç¼–è¯‘é¡¹ç›®..."
        dotnet build "Server/Server.csproj" --configuration Release --no-restore -v detailed

    - name: Publish Linux x64
      run: |
        echo "æ­£åœ¨å‘å¸ƒ Linux x64 ç‰ˆæœ¬..."
        dotnet publish "Server/Server.csproj" -c Release -r linux-x64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o ./publish/linux-x64
        echo "å‘å¸ƒå®Œæˆï¼Œæ–‡ä»¶åˆ—è¡¨ï¼š"
        Get-ChildItem -Path ./publish/linux-x64/ -Force
      shell: pwsh

    - name: Archive Linux x64 build
      run: |
        cd publish/linux-x64
        tar -czf ../Server-linux-x64.tar.gz *
      shell: bash

    - name: Upload Linux x64 artifact
      uses: actions/upload-artifact@v4
      with:
        name: Server-linux-x64
        path: publish/Server-linux-x64.tar.gz
        retention-days: 30

  build-docker-arm64:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image for ARM64
      run: |
        echo "æ­£åœ¨æ„å»º ARM64 Docker é•œåƒ..."
        docker buildx build \
          --platform linux/arm64 \
          --file Dockerfile.ARM \
          --tag zircon-server:arm64 \
          --output type=docker,dest=./zircon-server-arm64.tar \
          .
        echo "Docker é•œåƒæ„å»ºå®Œæˆ"

    - name: Compress Docker image
      run: |
        gzip zircon-server-arm64.tar
        echo "å‹ç¼©å®Œæˆï¼Œæ–‡ä»¶åˆ—è¡¨ï¼š"
        ls -lh zircon-server-arm64.tar.gz

    - name: Upload ARM64 Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: zircon-server-arm64-docker
        path: zircon-server-arm64.tar.gz
        retention-days: 30

  release:
    needs: [build-linux-x64, build-docker-arm64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download Linux x64 artifact
      uses: actions/download-artifact@v4
      with:
        name: Server-linux-x64
        path: ./release

    - name: Download ARM64 Docker artifact
      uses: actions/download-artifact@v4
      with:
        name: zircon-server-arm64-docker
        path: ./release

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/Server-linux-x64.tar.gz
          release/zircon-server-arm64.tar.gz
        body: |
          ## ğŸ‰ Linux x64 + ARM64 å‘å¸ƒç‰ˆæœ¬
          
          ### ğŸ“¦ åŒ…å«å†…å®¹
          
          #### Linux x64 å¯æ‰§è¡Œæ–‡ä»¶
          - Server å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆè‡ªåŒ…å« .NET 8.0 è¿è¡Œæ—¶ï¼‰
          - Library ä¾èµ–åº“
          - Web ç®¡ç†é¢æ¿é™æ€èµ„æº
          
          #### ARM64 Docker é•œåƒ
          - zircon-server-arm64.tar.gz - é€‚ç”¨äº ARM64 æ¶æ„çš„ Docker é•œåƒæ–‡ä»¶
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          
          #### Linux x64 ç›´æ¥è¿è¡Œ
          ```bash
          # è§£å‹æ–‡ä»¶
          tar -xzf Server-linux-x64.tar.gz
          
          # æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x Server
          
          # è¿è¡ŒæœåŠ¡å™¨
          ./Server
          ```
          
          #### ARM64 Docker éƒ¨ç½²
          ```bash
          # è§£å‹é•œåƒæ–‡ä»¶
          gunzip zircon-server-arm64.tar.gz
          
          # åŠ è½½ Docker é•œåƒ
          docker load -i zircon-server-arm64.tar
          
          # è¿è¡Œå®¹å™¨
          docker run -d \
            -p 7000:7000 \
            -p 7080:7080 \
            -v ./datas:/zircon/datas \
            --name zircon-server \
            zircon-server:arm64
          ```
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          
          #### Linux x64
          - Linux x64 ç³»ç»Ÿ
          - æ— éœ€å®‰è£… .NET è¿è¡Œæ—¶ï¼ˆå·²åŒ…å«ï¼‰
          
          #### ARM64 Docker
          - ARM64 æ¶æ„ç³»ç»Ÿï¼ˆå¦‚æ ‘è“æ´¾ 4ã€Apple M1/M2ã€AWS Graviton ç­‰ï¼‰
          - Docker ç¯å¢ƒ
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
